---
name: build

on: [pull_request, merge_group]


jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.13', '3.9']
      fail-fast: false
    env:
      # cache busting if requirements haven't changed
      CACHE_EPOCH: 1
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Cache pre-commit
      uses: actions/cache@v4
      with:
        path: ~/.cache/pre-commit
        key: ${{ runner.os }}-pre-commit-${{ matrix.python-version }}
    - name: Configure git to allow access to internal repos
      # this mirrors what actions/checkout does to allow cloning internal repos
      run: |
        git config --global http.https://github.com/arup-group/.extraheader "AUTHORIZATION: basic $(printf "x-access-token:%s" "${{secrets.OASYS_REPO_SCOPE_GITHUB_PAT}}" | base64)"
    - uses: astral-sh/setup-uv@v5
      name: Setup UV + Python
      with:
        python-version: ${{ matrix.python-version }}
        enable-cache: true
        cache-dependency-glob: |
          **/requirements*.txt
          **/pyproject.toml
          **/uv.lock
    - name: Install dependencies
      run: |
        git config --global user.email "you@example.com"
        git config --global user.name "Your Name"
        git config --global init.defaultBranch main
    - name: with git only
      run: |
        uvx cookiecutter -v --no-input -f -o /tmp/cookie_python . project_slug=foo2 minimum_python_version=${{ matrix.python-version }}
        cd /tmp/cookie_python/foo2
        uv sync --all-extras --all-groups
    - name: with git and pre-commit
      run: |
        uvx --with pre-commit cookiecutter -v --no-input -f -o /tmp/cookie_python . project_slug=foo3 minimum_python_version=${{ matrix.python-version }}
        cd /tmp/cookie_python/foo3
        uv sync --all-extras --all-groups
        uv run python -c "import tests"
        make -C docs html
    - name: upload generated projects
      uses: actions/upload-artifact@v4
      with:
        name: cookie_python_${{ matrix.python-version }}
        path: /tmp/cookie_python
